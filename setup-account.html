<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ - MCS</title>
    <link rel="stylesheet" href="control-style.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h1>
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹! ØªÙ…Øª Ø¯Ø¹ÙˆØªÙƒ Ù„ØªØµØ¨Ø­ Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… MCS</p>
            </div>
            
            <div class="user-info" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <img src="https://lh3.googleusercontent.com/a/ACg8ocIwrmQ4ZyLhsN0_5rdXUPR-TyQrVexf1h8jwHOzbgVDYhHUYA=s96-c" 
                     alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" 
                     style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #ffd700; margin-bottom: 10px;"
                     onerror="this.src='https://lh3.googleusercontent.com/a/ACg8ocIwrmQ4ZyLhsN0_5rdXUPR-TyQrVexf1h8jwHOzbgVDYhHUYA=s96-c'">
                
                <h3 style="color: #ffd700; margin: 10px 0 5px 0;" id="displayName"></h3>
                <p style="opacity: 0.8; margin-bottom: 10px;" id="displayEmail"></p>
                <div id="displayRole" style="margin-top: 10px;"></div>
            </div>
            
            <div class="login-form">
                <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-right: 4px solid #ffd700;">
                    <p style="margin: 0; color: #ffd700; font-weight: bold;">Ù…Ù„Ø§Ø­Ø¸Ø©:</p>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                        ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù†Ø¸Ø§Ù…: <strong>mcsadmin202224</strong>
                    </p>
                </div>
                
                <button id="activateBtn" class="login-btn" style="background: #4CAF50;">
                    âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
                </button>
                
                <div id="statusMessage" style="display: none; margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, doc, setDoc, deleteDoc } from './firebase-config.js';
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯Ø¹Ùˆ
        const user = JSON.parse(localStorage.getItem('mcs_user'));
        
        if (!user || user.type !== 'invitation') {
            window.location.href = 'index.html';
        }
        
        // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('displayName').textContent = user.name || user.email.split('@')[0];
        document.getElementById('displayEmail').textContent = user.email;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ± (Ù…Ø¤Ø³Ø³ Ø£Ùˆ Ù…Ø³Ø¤ÙˆÙ„)
        const permissions = user.permissions || [];
        let userRole = 'Ù…Ø³Ø¤ÙˆÙ„';
        let roleBadge = '<span style="display: inline-block; background: rgba(255,215,0,0.2); color: #ffd700; padding: 5px 15px; border-radius: 20px; border: 2px solid rgba(255,215,0,0.3); font-weight: bold; margin-top: 5px;">ğŸ‘¤ Ù…Ø³Ø¤ÙˆÙ„</span>';
        
        if (permissions.includes('Ø§Ù„Ù…Ø¤Ø³Ø³')) {
            userRole = 'Ø§Ù„Ù…Ø¤Ø³Ø³';
            roleBadge = '<span style="display: inline-block; background: rgba(255,0,0,0.2); color: #ff6b6b; padding: 5px 15px; border-radius: 20px; border: 2px solid rgba(255,0,0,0.3); font-weight: bold; margin-top: 5px;">ğŸ‘‘ Ø§Ù„Ù…Ø¤Ø³Ø³</span>';
        }
        
        document.getElementById('displayRole').innerHTML = roleBadge;
        
        document.getElementById('activateBtn').addEventListener('click', async () => {
            const activateBtn = document.getElementById('activateBtn');
            const statusDiv = document.getElementById('statusMessage');
            
            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            activateBtn.disabled = true;
            activateBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„...';
            
            try {
                console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„...');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
                const adminData = {
                    email: user.email,
                    name: user.name,
                    password: 'mcsadmin202224', // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
                    profileImage: user.photoURL,
                    permissions: user.permissions || [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: user.createdBy || 'system',
                    activatedAt: new Date().toISOString(),
                    role: userRole
                };
                
                console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', adminData);
                
                // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø© admins
                const adminsCollection = collection(db, 'admins');
                await setDoc(doc(adminsCollection, user.id), adminData);
                
                console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ admins:', user.id);
                
                // 2. Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© invitations
                const inviteDocRef = doc(db, 'invitations', user.id);
                await deleteDoc(inviteDocRef);
                
                console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† invitations:', user.id);
                
                // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ localStorage
                user.type = 'admin';
                user.permissions = adminData.permissions;
                user.role = userRole;
                localStorage.setItem('mcs_user', JSON.stringify(user));
                
                // 4. Ø­ÙØ¸ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                localStorage.setItem('controlLoggedIn', 'true');
                localStorage.setItem('loginTime', new Date().getTime());
                
                // 5. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <div style="background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 10px; border-radius: 5px;">
                        <p style="margin: 0; font-weight: bold;">âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                            Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...
                        </p>
                    </div>
                `;
                
                console.log('ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
                
                // 6. ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆÙ†ØµÙ
                setTimeout(() => {
                    window.location.href = 'enter-password.html';
                }, 1500);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
                activateBtn.disabled = false;
                activateBtn.innerHTML = 'âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„';
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `
                    <div style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; padding: 10px; border-radius: 5px;">
                        <p style="margin: 0; font-weight: bold;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                            ${error.message || 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}
                        </p>
                    </div>
                `;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>